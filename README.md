# ربات فروشگاهی تلگرام (فارسی)

این پروژه یک ربات فروشگاهی با **آیگرام (Aiogram v3)** و **FastAPI** است که امکانات زیر را فراهم می‌کند:

- منو مشتری: «ورود به فروشگاه»، «حساب کاربری»، «پشتیبانی»، «کانال ما»
- مدیریت دسته‌ها، محصولات، پلن‌ها (طرح‌های هر محصول) و «فیلدهای اطلاعات لازم» برای هر محصول
- پرداخت‌ها:
  - **کارت به کارت** (ارسال رسید و تایید دستی ادمین)
  - **درگاه‌های ایرانی** (قاب زارین‌پال و آیدی‌پی) — پیاده‌سازی اولیه و قابل توسعه
- پنل ادمین داخل تلگرام: تنظیم پشتیبانی، کانال، شماره کارت، مدیریت سفارش‌های در انتظار تایید

> **توجه:** برای استفاده از درگاه‌ها باید دامنه عمومی HTTPS داشته باشید و سرویس FastAPI را بالا بیاورید تا کال‌بک درگاه‌ها به آن بازگردد. برای توسعه می‌توانید از `ngrok` استفاده کنید.

## شروع سریع

1) پیش‌نیازها:
```bash
python -V  # پیشنهاد: Python 3.11+
pip install -r requirements.txt
```

2) فایل `.env` را از روی `.env.example` بسازید و مقادیر را تنظیم کنید:
- `BOT_TOKEN` را از BotFather بگیرید.
- `ADMINS` را با ایدی عددی تلگرام ادمین‌ها پر کنید.
- اگر می‌خواهید درگاه‌ها فعال باشند `BASE_URL` (دامنه)، `ZARINPAL_MERCHANT_ID` یا `IDPAY_API_KEY` را تنظیم کنید.

3) اجرای ربات با **Polling** (ساده‌ترین روش برای تست):
```bash
python -m app.run_polling
```

4) اجرای سرویس FastAPI برای **کال‌بک درگاه‌ها** (در صورت نیاز به پرداخت آنلاین):
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000
```
- آدرس کال‌بک‌ها:
  - زرین‌پال: `{BASE_URL}/payments/zarinpal/callback`
  - آیدی‌پی: `{BASE_URL}/payments/idpay/callback`

> می‌توانید همزمان ربات را با polling اجرا کنید و FastAPI را جداگانه بالا بیاورید.
> دیتابیس SQLite مشترک است و وضعیت سفارش‌ها را همگام نگه می‌دارد.

## نکات
- پیام‌های ربات فارسی هستند.
- ساختار دیتابیس با SQLAlchemy ایجاد می‌شود (اولین اجرا).
- برای «فیلدهای اطلاعات لازم» هر محصول، ادمین می‌تواند یک JSON لیست وارد کند، مثل:
```json
["username_receiver", "note"]
```
ربات هنگام خرید این فیلدها را از مشتری می‌پرسد.

## ساختار پروژه

```
app/
  __init__.py
  bot.py
  config.py
  db.py
  models.py
  texts.py
  keyboards.py
  utils.py
  main.py            # FastAPI (کال‌بک درگاه‌ها)
  run_polling.py     # اجرای ربات با polling
  handlers/
    user.py
    admin.py
    payments.py
  services/
    payments/
      base.py
      zarinpal.py
      idpay.py
```

## لایسنس
MIT
